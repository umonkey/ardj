#!/usr/bin/env python
# vim: set ts=4 sts=4 sw=4 noet fileencoding=utf-8:

import getopt
import os
import signal
import sys
import traceback

def usage():
	print "Usage: %s [options]" % os.path.basename(sys.argv[0])
	print "\nOptions:"
	print " --add        adds tracks to the database"
	print " --backup     save metadata to file tags"
	print " --config     edit config file"
	print " --dbconsole  open SQLite console"
	print " --debug      enable extra logging"
	print " --jabber     run a jabber bot"
	print " --next       show next track"
	print " --quiet      suppress log messages (stderr)"
	print " --reset      reset database"
	print " --restart    restart a running jabber bot"
	print " --scrobble   scrobble track (only makes sense with --next)"
	print " --stats      show database statistics"
	print " --tags       specify tags for --add"
	print " --update     update database"
	return 1

def run(commands, args):
	if type(commands) != list:
		commands = [commands]
	dirs = os.getenv('PATH').split(os.pathsep)
	for command in [x for x in commands if x]:
		for dir in dirs:
			cmd = os.path.join(dir, command)
			if command and os.path.exists(cmd):
				args.insert(0, os.path.basename(cmd))
				return os.execv(cmd, args)
	print >>sys.stderr, '%s not found in $PATH.' % '|'.join(commands)
	sys.exit(1)

if __name__ == '__main__':
	# Allow running from sources.
	if not os.path.abspath(sys.argv[0]).startswith('/usr'):
		sys.path.insert(0, os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(sys.argv[0]))), 'src'))
		# print >>sys.stderr, 'Using modules from %s.' % sys.path[0]

	from ardj import Open
	ardj = Open()

	try:
		opts, args = getopt.getopt(sys.argv[1:], 'i', ['add', 'backup', 'config', 'dbconsole', 'debug', 'jabber', 'jabber-child', 'next', 'quiet', 'reset', 'restart', 'scrobble', 'stats', 'tags=', 'update'])
	except getopt.GetoptError:
		sys.exit(usage())

	if not len(opts):
		sys.exit(usage())

	tags = []

	# prepare for work
	for option, value in opts:
		if '--quiet' == option:
			sys.stderr = None
		if '--debug' == option:
			ardj.debug = True
		if '--tags' == option:
			tags = value.split(',')

	for option, value in opts:
		if '--add' == option:
			for filename in args:
				ardj.add_file(filename)
			ardj.database.commit()
			args = []
		if '--backup' == option:
			import db
			idx, tracks = 1, db.track.get_all()
			for track in tracks:
				if os.path.exists(track.path):
					print '%u/%u\r' % (idx, len(tracks)),
					sys.stdout.flush()
					track.backup()
				idx += 1
			print
		if '--dbconsole' == option:
			run('sqlite3', [ardj.config.get_db_name()])
		if '--config' == option:
			run([os.getenv('EDITOR'), 'editor'], [ardj.config.filename])
		if '--jabber' == option:
			import subprocess, time
			while True:
				args = [sys.argv[0], '--jabber-child']
				if ardj.debug:
					args.append('--debug')
				if not subprocess.Popen(args).wait():
					sys.exit(0)
				print >>sys.stderr, 'Unclean shutdown, restarting in 5 seconds.'
				time.sleep(5)
		if '--jabber-child' == option:
			ret = ardj.get_bot().run()
			ardj.close()
			sys.exit(ret)
		if '--next' == option:
			track = ardj.get_next_track()
			if track is None:
				print >>sys.stderr, 'Could not find a track to play.'
				sys.exit(1)
			if ('--scrobble', '') in opts:
				track.scrobble()
			print track['filepath']
		if '--reset' == option:
			filename = ardj.config.get_db_name()
			if os.path.exists(filename):
				os.unlink(filename)
				print 'OK'
		if '--restart' == option:
			import subprocess
			pidfile = '/tmp/ardj-jabber.pid'
			if os.path.exists(pidfile):
				pid = int(open(pidfile).read().strip())
				try:
					os.kill(pid, signal.SIGTERM)
				except OSError: pass
				subprocess.Popen(['/usr/bin/killall', '-HUP', 'ices']).wait()
		if '--stats' == option:
			stats = ardj.get_stats()
			print '%u tracks, %.1f hours.' % (stats['tracks'], stats['seconds'] / 60 / 60)
		if '--update' == option:
			ardj.sync()
