<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>ardj</title><link rel="stylesheet" type="text/css" href="screen.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.76.1" /><meta name="description" content="Программный комплекс ardj предназначен для создания полностью автоматизированной интернет-радиостанции, управляемой пользователями, с минимальным адмнистрированием или вообще без него. Комплекс позволяет составлять умные плейлисты произвольной сложности, получать звуковые файлы из внешних источников, управлять эфиром через jabber и многое другое.  В целом комплекс настроен на создание полностью автономной радиостанции; если вам нужен контроль над плейлистом с точностью до секунды и полностью ручное управление, вам больше подойдёт такое ПО, как SAM Broadcaster или Internet DJ Console. Это руководство содержит всю информацию, необходимую для работы запуска радиостанции, основанной на ardj, и работы с ней." /></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="ru" class="book" title="ardj" xml:lang="ru"><div class="titlepage"><div><div><h1 class="title"><a name="idm14939904" id="idm14939904"></a>ardj</h1></div><div><div class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Justin</span> <span class="surname">Forest</span></h3></div></div></div><div><p class="releaseinfo">1.0.15</p></div><div><div class="abstract" title="Аннотация"><p class="title"><b>Аннотация</b></p><p>Программный комплекс <span class="application">ardj</span> предназначен для создания полностью автоматизированной
      интернет-радиостанции, управляемой пользователями, с минимальным адмнистрированием или вообще без него.</p><p>Комплекс позволяет составлять умные плейлисты произвольной сложности, получать звуковые файлы из внешних
      источников, управлять эфиром через jabber и многое другое.  В целом комплекс настроен на создание полностью
      автономной радиостанции; если вам нужен контроль над плейлистом с точностью до секунды и полностью ручное
      управление, вам больше подойдёт такое ПО, как SAM Broadcaster или Internet DJ Console.</p><p>Это руководство содержит всю информацию, необходимую для работы запуска радиостанции, основанной на ardj, и
      работы с ней.</p></div></div></div><hr /></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="chapter"><a href="#architecture">1. Архитектура</a></span></dt><dd><dl><dt><span class="section"><a href="#media-db">Медиатека</a></span></dt><dt><span class="section"><a href="#ratings">Рейтинг композиций</a></span></dt></dl></dd><dt><span class="chapter"><a href="#installing">2. Установка</a></span></dt><dd><dl><dt><span class="section"><a href="#prereq">Предварительная информация</a></span></dt><dt><span class="section"><a href="#install-ubuntu">Установка в Ubuntu</a></span></dt><dt><span class="section"><a href="#install-debian">Установка в Debian</a></span></dt></dl></dd><dt><span class="chapter"><a href="#settings">3. Настройка</a></span></dt><dd><dl><dt><span class="section"><a href="#quickstart">Быстрый запуск</a></span></dt><dt><span class="section"><a href="#festival">Настройка синтезатора речи</a></span></dt><dt><span class="section"><a href="#last-fm">Взаимодействие с Last.fm</a></span></dt><dt><span class="section"><a href="#libre-fm">Взаимодействие с Libre.fm</a></span></dt><dt><span class="section"><a href="#listener-count">Доступ к количеству слушателей</a></span></dt><dt><span class="section"><a href="#third-party">Настройка сторонних программ</a></span></dt><dd><dl><dt><span class="section"><a href="#upload-sftp">Загрузка музыки по протоколу SFTP</a></span></dt><dt><span class="section"><a href="#ezstream-sox">Настройка ezstream и sox</a></span></dt></dl></dd><dt><span class="section"><a href="#admins">Управление доступом ко специальным командам</a></span></dt></dl></dd><dt><span class="chapter"><a href="#programming">4. Программирование эфира</a></span></dt><dd><dl><dt><span class="section"><a href="#playlists">Плейлисты</a></span></dt><dt><span class="section"><a href="#custom-playlist">Ручное программирование</a></span></dt><dt><span class="section"><a href="#queue">Управление очередью (заказы)</a></span></dt><dt><span class="section"><a href="#preroll">Подмотка</a></span></dt><dd><dl><dt><span class="section"><a href="#preroll-playlist">Подмотка для плейлиста</a></span></dt><dt><span class="section"><a href="#preroll-labels">Подмотка для меток</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#usage">5. Использование</a></span></dt><dd><dl><dt><span class="section"><a href="#adding-music">Добавление музыки</a></span></dt><dt><span class="section"><a href="#voting">Оценка композиций</a></span></dt><dt><span class="section"><a href="#listening-statistics">Получение статистики</a></span></dt></dl></dd><dt><span class="chapter"><a href="#webapi">6. Web API</a></span></dt><dd><dl><dt><span class="section"><a href="#auth-json">api/auth.json</a></span></dt><dt><span class="section"><a href="#status-json">api/status.json</a></span></dt><dt><span class="section"><a href="#track-rocks-json">api/track/rocks.json</a></span></dt><dt><span class="section"><a href="#track-sucks-json">api/track/sucks.json</a></span></dt><dt><span class="section"><a href="#track-info-json">api/track/info.json</a></span></dt></dl></dd><dt><span class="appendix"><a href="#command-line">A. Описание параметров командной строки</a></span></dt><dt><span class="appendix"><a href="#jabber-commands">B. Описание команд jabber-бота</a></span></dt></dl></div><div class="list-of-examples"><p><b>Список примеров</b></p><dl><dt>3.1. <a href="#public-commands-example">Настройка доступа к командам jabber-бота</a></dt><dt>3.2. <a href="#democratic-admins-example">Автоматическое присвоение статуса администратора</a></dt><dt>5.1. <a href="#total-playlog-example">Общий отчёт о прослушиваниях</a></dt><dt>5.2. <a href="#daily-playlog-example">Суточный отчёт о прослушиваниях</a></dt><dt>6.1. <a href="#web-api-js">Использование JS-интерфейса WebAPI</a></dt><dt>B.1. <a href="#jabber-download-example">Загрузка музыки из открытых источников</a></dt><dt>B.2. <a href="#jabber-play-example">Создание плейлиста на ходу</a></dt><dt>B.3. <a href="#jabber-tags-example">Изменение меток композиции</a></dt></dl></div><div class="chapter" title="Глава 1. Архитектура"><div class="titlepage"><div><div><h2 class="title"><a name="architecture" id="architecture"></a>Глава 1. Архитектура</h2></div></div></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="section"><a href="#media-db">Медиатека</a></span></dt><dt><span class="section"><a href="#ratings">Рейтинг композиций</a></span></dt></dl></div><div class="section" title="Медиатека"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="media-db" id="media-db"></a>Медиатека</h2></div></div></div><p>Все звуковые файлы хранятся в специальной папке (обычно <code class="filename">/var/lib/ardj/music</code>) и имеют
      имена, состоящие из 32 цифр или букв от a до f.  Выглядит это примерно так:</p><pre class="programlisting">/var/lib/ardj/music/7/7/7707be8b5c2bf7bd3316c9af384d78c7.ogg
/var/lib/ardj/music/7/7/77aa258aebc67db32c7353c67c67b4ad.mp3
/var/lib/ardj/music/7/7/774b2e4eaf3141c04d14da6d9dbc0807.mp3</pre><p>Метаданные, используемые в работе, хранятся в базе данных и в файлы не записываются.</p><p>Для <a class="link" href="#adding-music" title="Добавление музыки">добавления файлов</a> в медиатеку используется папка для входящих
      файлов, добавлять их напрямую в медиатеку бесполезно — они не будут обнаружены.</p></div><div class="section" title="Рейтинг композиций"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ratings" id="ratings"></a>Рейтинг композиций</h2></div></div></div><p>У каждой композиции есть два рейтинга: реальный, зависящий от количества проголосовавших пользователей, и
      оперативный, используемый в ротации.</p><p>Реальный рейтинг композиции по умолчанию равен 1.0 и изменяется на 0.25 с каждым <a class="link" href="#voting" title="Оценка композиций">голосом</a> слушателя (засчитывается только последний голос, так что каждый слушатель может
      изменить реальный рейтинг композиции только на +0.25 или -0.25).  Голос пользователя при этом умножается на его
      вес, который рассчитывается по формуле (T-X)/T, где T=30, а X — количество дней с последнего голосования за любую
      композицию.  Если слушатель перестаёт голосовать, сила его голоса плавно затухает, а по истечение 30 дней его
      голос вообще перестаёт что-либо значить.  Однако как только пользователь снова проголосует, его прежние голоса
      снова начнут влиять не реальный рейтинг композиций.</p><p>Оперативный рейтинг изначально равен реальному, но изменяется на 0.25 при каждом голосовании после того, как
      песня прозвучала вновь (т.е. один раз за проигрывание песни).  При повторном голосовании рейтинг изменяется снова,
      что даёт целеустремлённому слушателю возможность вывести композицию в самый топ или загнать её в самый низ (но не
      ниже 0.25).  Этот рейтинг непосредственно влияет на вероятность попадания песни в плейлист.  Однако при каждом
      проигрывании песни рейтинг на 0.1 приближается к реальному значению, то есть медленно восстанавливается.</p><p>Для голосования за песни используется jabber-бот и команды <a class="link" href="#jabber-rocks"><span class="command"><strong>rocks</strong></span></a> и <a class="link" href="#jabber-sucks"><span class="command"><strong>sucks</strong></span></a>.</p></div></div><div class="chapter" title="Глава 2. Установка"><div class="titlepage"><div><div><h2 class="title"><a name="installing" id="installing"></a>Глава 2. Установка</h2></div></div></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="section"><a href="#prereq">Предварительная информация</a></span></dt><dt><span class="section"><a href="#install-ubuntu">Установка в Ubuntu</a></span></dt><dt><span class="section"><a href="#install-debian">Установка в Debian</a></span></dt></dl></div><p>В этом разделе описана установка и запуск радиостанции в типичной конфигурации.  Настройка дополнительных
    функций описана в следующем разделе.</p><div class="section" title="Предварительная информация"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="prereq" id="prereq"></a>Предварительная информация</h2></div></div></div><p>Перед началом установки приготовьте следующую информацию:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Логин и пароль учётной записи в <a class="ulink" href="http://www.jabberworld.info/" target="_top">системе Jabber</a>.  Общаясь с
      этим роботом вы будете оперативно управлять работой станции.</p></li><li class="listitem"><p>Логин и пароль от учётной записи в Last.fm.  Она может использоваться для скачивания свежей музыки,
      определения тэгов и загрузки музыки, похожей на всё хорошее, что звучит в вашем эфире.</p></li><li class="listitem"><p>Логин и пароль от учётной записи в Twitter.com или Identi.ca, куда робот будет сообщать о начале прямых
      эфиров.</p></li></ul></div></div><div class="section" title="Установка в Ubuntu"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install-ubuntu" id="install-ubuntu"></a>Установка в Ubuntu</h2></div></div></div><p>Самый оптимальный способ установки в Ubuntu — использование <a class="ulink" href="https://launchpad.net/~umonkey/+archive/ardj" target="_top">репозитория PPA</a>.  Установка всего необходимого ПО
  выполняется следующими командами:</p><pre class="programlisting">sudo apt-add-repository ppa:umonkey/ardj
sudo apt-get update
sudo apt-get install icecast2 ezstream sox libsox-fmt-mp3 mp3gain vorbisgain ardj</pre><p>После этого нужно <a class="link" href="#settings" title="Глава 3. Настройка">настроить компоненты</a> и вручную запустить службы:</p><pre class="programlisting">sudo start ardj-server
sudo start ardj-jabber
sudo start ardj-ezstream</pre><p>При перезагрузке сервера эти службы будут запускаться автоматически.</p></div><div class="section" title="Установка в Debian"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install-debian" id="install-debian"></a>Установка в Debian</h2></div></div></div><p>Самый оптимальный способ установки в Ubuntu — использование <a class="ulink" href="https://launchpad.net/~umonkey/+archive/ardj" target="_top">репозитория PPA</a>.  Установка всего необходимого ПО
  выполняется следующими командами:</p><pre class="programlisting">echo "deb http://ppa.launchpad.net/umonkey/ardj/ubuntu maverick main" | sudo tee /etc/apt/sources.list.d/ardj.list
sudo apt-get update
sudo apt-get install icecast2 ezstream sox libsox-fmt-mp3 mp3gain vorbisgain ardj
</pre><p>После этого нужно <a class="link" href="#settings" title="Глава 3. Настройка">настроить компоненты</a> и вручную запустить службы:</p><pre class="programlisting">sudo service ardj-server start
sudo service ardj-jabber start
sudo service ardj-ezstream start</pre><p>При перезагрузке сервера эти службы будут запускаться автоматически.</p></div></div><div class="chapter" title="Глава 3. Настройка"><div class="titlepage"><div><div><h2 class="title"><a name="settings" id="settings"></a>Глава 3. Настройка</h2></div></div></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="section"><a href="#quickstart">Быстрый запуск</a></span></dt><dt><span class="section"><a href="#festival">Настройка синтезатора речи</a></span></dt><dt><span class="section"><a href="#last-fm">Взаимодействие с Last.fm</a></span></dt><dt><span class="section"><a href="#libre-fm">Взаимодействие с Libre.fm</a></span></dt><dt><span class="section"><a href="#listener-count">Доступ к количеству слушателей</a></span></dt><dt><span class="section"><a href="#third-party">Настройка сторонних программ</a></span></dt><dd><dl><dt><span class="section"><a href="#upload-sftp">Загрузка музыки по протоколу SFTP</a></span></dt><dt><span class="section"><a href="#ezstream-sox">Настройка ezstream и sox</a></span></dt></dl></dd><dt><span class="section"><a href="#admins">Управление доступом ко специальным командам</a></span></dt></dl></div><div class="section" title="Быстрый запуск"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quickstart" id="quickstart"></a>Быстрый запуск</h2></div></div></div><p>В этом разделе описывается последовательность действий по запуску радиостанции на примере операционной системы
      Ubuntu Linux.  Действия для других операционных систем аналогичны, с поправкой на использование местного менеджера
      пакетов и названий некоторых пакетов.  Предполагается, что пользователь умеет редактировать текстовые файлы.</p><p>Сначала нужно активировать репозитории <a class="ulink" href="https://help.ubuntu.com/community/Repositories/CommandLine#Adding_the_Universe_and_Multiverse_Repositories" target="_top">Universe,
      Muiltiverse</a> и <a class="ulink" href="https://help.ubuntu.com/community/Medibuntu#Adding_the_Repository" target="_top">Medibuntu</a>.  Затем нужно установить
      используемые системные пакеты:</p><pre class="programlisting">sudo apt-get install python-yaml python-mutagen \
  python-oauth python-feedparser python-httplib2
  python-webpy python-dnspython python-socksipy \
  ices icecast2 python-simplejson</pre><p>Затем нужно скачать и установить пакет ardj:</p><pre class="programlisting">wget http://ardj.googlecode.com/files/ardj-1.0-2011.08.12.0215.deb
sudo dpkg -i ardj-1.0-2011.08.12.0215.deb</pre><p>Теперь нужно скопировать из примеров конфигурационные файлы для ices0 и icecast2:</p><pre class="programlisting">sudo cp /usr/share/doc/ardj/examples/icecast.xml /etc/icecast2/
sudo cp /usr/share/doc/ardj/examples/ices.conf /etc/</pre><p>В файле <code class="filename">/etc/default/icecast2</code> нужно заменить "ENABLE=false" на "ENABLE=true":</p><pre class="programlisting">sudo editor /etc/default/icecast2</pre><p>Теперь можно запустить все службы:</p><pre class="programlisting">sudo service icecast2 start
sudo start ardj-server
sudo start ardj-ices</pre><p>Готово.  Станция должна работать.  Чтобы убедиться в этом, подключитесь к основному потоку:</p><pre class="programlisting">mplayer http://127.0.0.1:8180/live.mp3</pre><p>После этого обычно в файлах <code class="filename">icecast.xml</code> и <code class="filename">ices.conf</code> меняют пароли
      для подключения к вещанию, в файле <code class="filename">/etc/ardj.yaml</code> указать параметры доступа к джабберу и <a class="link" href="#last-fm" title="Взаимодействие с Last.fm">Last.fm</a>, и создают более сложные плейлисты.</p></div><div class="section" title="Настройка синтезатора речи"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="festival" id="festival"></a>Настройка синтезатора речи</h2></div></div></div><p>Синтез речи может использоваться в скриптах для анонсирования каких-то событий, и может быть доступен
  пользователям через джаббер-бота в развлекательных целях.  Работает это так: вы загружаете в <a class="link" href="#media-db" title="Медиатека">медиатеку</a> файл формата OGG/Vorbis (с расширением <code class="filename">.ogg</code>), затем ardj
  преобразует текст в речь, записывает в этот файл и ставит его в <a class="link" href="#queue" title="Управление очередью (заказы)">очередь
  проигрывания</a>.</p><p>Единственным свободным синтезатором речи, прилично говорящим по-русски, является <a class="ulink" href="http://www.cstr.ed.ac.uk/projects/festival/" target="_top">festival</a>.  Установить его в системе Debian (Ubuntu) можно
  такой командой:</p><pre class="programlisting">sudo apt-get install festival festvox-ru</pre><p>После этого <a class="link" href="#adding-music" title="Добавление музыки">загрузите</a> в медиатеку любой файл формата OGG/Vorbis и определите
  его идентификатор — это делается командой <a class="link" href="#jabber-news"><span class="command"><strong>news</strong></span></a> или <a class="link" href="#jabber-find"><span class="command"><strong>find</strong></span></a>:</p><pre class="programlisting">&gt; find экстренное
Found only these tracks:
«Экстренное сообщение» by Микроша — #4656 ⚖1.96 ♺323 @special</pre><p>Укажите найденный идентификатор ("4656" в примере) в конфигурационном файле (обычно
  <code class="filename">/etc/ardj.yaml</code>):</p><pre class="programlisting">festival_track_id: 4656</pre><p>После этого перезапустите jabber-бота командой <a class="link" href="#jabber-restart"><span class="command"><strong>restart</strong></span></a>, чтобы изменения вступили в силу.</p><p>Теперь можно отправить джаббер-боту команду <a class="link" href="#jabber-speak"><span class="command"><strong>speak</strong></span></a> с
  текстом, который ему следует произнести.  Результат будет записан в файл, соответствующий указанной дорожке.  Выглядит
  это так:</p><pre class="programlisting">&gt; speak привет, меня зовут микроша. гамбургеры заворачивать теперь буду я
OK, please wait until the current song finishes playing.</pre><p>Запрошенная фраза прозвучит по окончании проигрываемой композиции.  Убедиться, что она встала в очередь, можно
  командой <a class="link" href="#jabber-queue"><span class="command"><strong>queue</strong></span></a>:</p><pre class="programlisting">&gt; queue
Current queue:                                               
«Экстренное сообщение» by Микроша — #4656 ⚖2.21 ♺325 @special</pre></div><div class="section" title="Взаимодействие с Last.fm"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="last-fm" id="last-fm"></a>Взаимодействие с Last.fm</h2></div></div></div><p>Взаимодействие с Last.fm двунаправленное: робот отправляет на сервер информацию о проигрываемых и «любимых»
      композициях, а от сервера получает информацию для коррекции имён исполнителей и свежую музыку.  Чтобы всё это
      работало, в конфигурационный файл нужно добавить такой блок:</p><pre class="programlisting">last.fm:
  key: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
  secret: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
  login: alice
  password: secret</pre><p>Параметры <code class="option">key</code> и <code class="option">secret</code> можно получить после <a class="ulink" href="http://www.lastfm.ru/api/account" target="_top">регистрации собственного приложения</a> (процедура бесплатна и занимает
      несколько минут).</p><p>Для включения скробблинга в конфигурационный файл следует добавить такую строку:</p><pre class="programlisting">last_fm_scrobble: true</pre><p>Чтобы исключить из процесса скробблинга композиции с определёнными метками (например, джинглы), укажите их в
      параметре <code class="option">last_fm_skip_labels</code> конфигурационного файла:</p><pre class="programlisting">last_fm_skip_labels: [jingle, quotes, news, special]</pre><p>Наконец, чтобы знать, откуда пришла новая музыка, можно добавить к файлам, загруженным из Last.fm,
      специальные метки.  Для этого их нужно указать в параметре <code class="option">last_fm_add_labels</code> конфигурационного
      файла:</p><pre class="programlisting">last_fm_add_labels: [tagme, source:last.fm]</pre></div><div class="section" title="Взаимодействие с Libre.fm"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="libre-fm" id="libre-fm"></a>Взаимодействие с Libre.fm</h2></div></div></div><p>Libre.fm — это сервис скробблинга, аналогичный Last.fm, только полностью открытый и без дополнительных
      функций, вроде афиши или скачивания музыки.  Подключается сервис добавлением в конфигурационный файл таких
      строк:</p><pre class="programlisting">libre_fm:
  login: alice
  password: secret</pre><p>Для предотвращения скробблинга специфических дорожек — вроде джинглов — укажите их метки:</p><pre class="programlisting">libre_fm_skip_labels: [jingle, news, special]</pre></div><div class="section" title="Доступ к количеству слушателей"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="listener-count" id="listener-count"></a>Доступ к количеству слушателей</h2></div></div></div><p>Количество активных слушателей знает сервер icecast2.  Чтобы получить эту информацию, нужно запросить
      административную страницу по протоколу HTTP, затем распарсить её (к счастью, это XML-документ).  Чтобы
      <span class="command"><strong>ardj</strong></span> мог делать это автоматически, в конфигурационном файле нужно указать параметры подключения
      к серверу:</p><pre class="programlisting">icecast_stats_url: "http://alice:secret@localhost:8180/admin/stats.xml"</pre></div><div class="section" title="Настройка сторонних программ"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="third-party" id="third-party"></a>Настройка сторонних программ</h2></div></div></div><p>В этой секции описана настройка программ, часто используемых вместе с ardj, но не имеющих к нему
      отношения.</p><div class="section" title="Загрузка музыки по протоколу SFTP"><div class="titlepage"><div><div><h3 class="title"><a name="upload-sftp" id="upload-sftp"></a>Загрузка музыки по протоколу SFTP</h3></div></div></div><p>Протокол SFTP является безопасным аналогом протокола FTP, работающим
	поверх SSH.  Для того, чтобы предоставить пользователям возможность
	безопасно (для сервера) загружать музыку, следует создать специального
	пользователя — назовём его "ardj-uploader" — для которого домашней папкой
	будет <code class="filename">/var/lib/ardj/incoming</code>, добавить его в группу
	"ardj", а в файл <code class="filename">/etc/ssh/sshd_config</code> добавить такие
	строки:</p><pre class="programlisting">Match Group ardj
ChrootDirectory %h
ForceCommand internal-sftp
AllowTcpForwarding no</pre><p>Теперь пользователь ardj-uploader может подключаться к серверу по протоколу SFTP и может складывать файлы
	в папку incoming; подключаться по SSH, загружать файлы в другие папки или доставать их оттуда он не
	может.</p></div><div class="section" title="Настройка ezstream и sox"><div class="titlepage"><div><div><h3 class="title"><a name="ezstream-sox" id="ezstream-sox"></a>Настройка ezstream и sox</h3></div></div></div><p>В базовой конфигурации ezstream <a class="ulink" href="http://svn.xiph.org/trunk/ezstream/examples/ezstream_reencode_mp3.xml" target="_top">рекомендуется</a>
  для декодирования файлов использовать специализированные утилиты для каждого
  формата: oggdec, madplay, flac.  Этот вариант плох по двум причинам.
  Во-первых, эти утилиты не поддерживают <a class="ulink" href="http://ru.wikipedia.org/wiki/Replay_Gain" target="_top">ReplayGain</a>, что для
  радиостанции критично.  Во-вторых, не все их них поддерживают ресэмплинг, от
  чего монофонические файлы, если они попадаются в плейлисте, звучат ввое
  быстрее.</p><p>Эту проблему можно решить использованием в качестве декодера утилиты
  <a class="ulink" href="http://sox.sourceforge.net/" target="_top">sox</a>.  Дополнительным
  преимуществом является простота: sox — это одна утилита, поддерживающая все
  форматы.</p><p>Для использования sox замените все описания декодеров в файле
  <code class="filename">/etc/ezstream.xml</code> на следующее:</p><pre class="programlisting">&lt;decode&gt;sox --replay-gain track "@T@" -r 44100 -c 2 -t raw -e signed-integer -&lt;/decode&gt;</pre></div></div><div class="section" title="Управление доступом ко специальным командам"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="admins" id="admins"></a>Управление доступом ко специальным командам</h2></div></div></div><p>Большая часть <a class="link" href="#jabber-commands" title="Приложение B. Описание команд jabber-бота">команд jabber-бота</a>, модифицирующих сведения о композициях,
  или управляющих самим ботом, доступна только администраторам.  По умолчанию обычным пользователям доступны команды
  получения информации и <a class="link" href="#voting" title="Оценка композиций">голосования</a>.</p><p>Для предоставления публичного доступа к закрытым командам используется параметр public_jabber_commands
  конфигурационного файла.  По умолчанию он не установлен, что эквивалентно такому определению:</p><div class="example"><a name="public-commands-example" id="public-commands-example"></a><p class="title"><b>Пример 3.1. Настройка доступа к командам jabber-бота</b></p><div class="example-contents"><pre class="programlisting">public_jabber_commands: [admins, bm, dump, download, echo, find,
  help, hitlist, last, news, queue, rocks, shitlist, show,
  speak, status, sucks, tags, upload]</pre></div></div><br class="example-break" /><p>Демократические радиостанции могут автоматически выдавать пользователям доступ к администрированию.  Для этого
  нужно указать количество наиболее активно голосующих пользователей, которым выдаются привилегии, и количество дней, за
  которые учитываются голоса.  По умолчанию функция отключена.  Список текущих администраторов можно получить командой
  <a class="link" href="#jabber-admins"><span class="command"><strong>admin</strong></span></a>.</p><div class="example"><a name="democratic-admins-example" id="democratic-admins-example"></a><p class="title"><b>Пример 3.2. Автоматическое присвоение статуса администратора</b></p><div class="example-contents"><pre class="programlisting">promote_voters: 10
promote_voters_days: 14</pre><p>В этом примере статус администратора выдаётся 10 пользователям, наиболее активно голосовавшим за последние две
    недели.</p></div></div><br class="example-break" /></div></div><div class="chapter" title="Глава 4. Программирование эфира"><div class="titlepage"><div><div><h2 class="title"><a name="programming" id="programming"></a>Глава 4. Программирование эфира</h2></div></div></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="section"><a href="#playlists">Плейлисты</a></span></dt><dt><span class="section"><a href="#custom-playlist">Ручное программирование</a></span></dt><dt><span class="section"><a href="#queue">Управление очередью (заказы)</a></span></dt><dt><span class="section"><a href="#preroll">Подмотка</a></span></dt><dd><dl><dt><span class="section"><a href="#preroll-playlist">Подмотка для плейлиста</a></span></dt><dt><span class="section"><a href="#preroll-labels">Подмотка для меток</a></span></dt></dl></dd></dl></div><div class="section" title="Плейлисты"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="playlists" id="playlists"></a>Плейлисты</h2></div></div></div><p>Плейлисты описываются в файле <code class="filename">playlists.yaml</code>, который находится в корне <a class="link" href="#media-db" title="Медиатека">медиатеки</a> (обычно называется <code class="filename">/var/lib/ardj/music/playlists.yaml</code>, но
      имя может быть изменено с помощью конфигурационного файла).  Описываются они в таком виде:</p><pre class="programlisting">- name: jingles
  delay: 30

- name: music
  weight: 1.0-100</pre><p>Плейлисты обрабатываются сверху вних.  Описанная конфигурация означает, что раз в 30 минут надо играть
      композицию с меткой "jingles", а всё остальное время — композиции с меткой "music" и весом ≥1.0.</p><div class="variablelist" title="Возможные параметры плейлистов"><p class="title"><b>Возможные параметры плейлистов</b></p><dl><dt><span class="term"><code class="option">name</code></span></dt><dd><p>Название плейлиста.  По умолчанию используется в качестве метки, которую должны иметь композиции, для
            попадания в этот плейлист (метки можно также указать парамером <code class="option">labels</code>).</p></dd><dt><span class="term"><code class="option">weight</code></span></dt><dd><p>Границы веса композиций, указываются в виде диапазона: min-max (включительно).  Композиции с весом,
            выходящим за указанные пределы, из плейлиста исключаются.  Если значение не указано — в плейлист попадают
            все композиции.</p></dd><dt><span class="term"><code class="option">delay</code></span></dt><dd><p>Задержка для плейлиста.  Указывает время в минутах, на которое плейлист отключается после проигрывания
            композиции из него.  Значение 30 означает, что композиции из этого плейлиста будут звучать не чаще раза в
            полчаса.</p><p>Плейлист блокируется не только при выборе композиции непосредственно из него, но и при проигрывании
            вообще любой композиции, которая удовлетворяет условиям плейлиста.</p></dd><dt><span class="term"><code class="option">track_delay</code></span></dt><dd><p>Задержка для композиций.  Указывает время в минутах, на которое композиция исключается из плейлиста
            при проигрывании.  Фактически это означает, что композиция должна была быть в предыдущий раз проиграна не
            ранее чем указанное количество минут назад.  Этот параметр используется для предотвращения повторов в
            специализированных коротких плейлистах, вроде десятки лучших песен.</p></dd><dt><span class="term"><code class="option">history</code></span></dt><dd><p>Количество композиций, в течение которых исполнитель не должен повторяться (по умолчанию 5). 
            Композиции, принадлежащие указанному количеству последних звучавших исполнителей, из плейлиста исключаются. 
            При этом следует иметь в виду, что проверка ведётся не только по текущему плейлисту, но по всей истории, то
            есть в указанное количество будут включены и джинглы, и всё, что звучало.</p></dd><dt><span class="term"><code class="option">repeat</code></span></dt><dd><p>Максимальное количество проигрываний для композиции.  Композиции, проигранные более указанного
            количества раз, из плейлиста исключаются.  Этот параметр может использоваться, например, для организации
            усиленной ротации новых песен.</p></dd><dt><span class="term"><code class="option">hours</code></span></dt><dd><p>Часы активности плейлиста.  Указываются в виде списка значений или диапазонов, например:</p><pre class="programlisting">hours: [8, 12-20, 22]</pre><p>В такой конфигурации плейлист будет активен с 8 до 0 часов утра, с 12 дня до 8 вечера и с 10 до 11
            вечера.</p></dd><dt><span class="term"><code class="option">days</code></span></dt><dd><p>Дни активности плейлиста.  Указываются в виде списка значений или диапазонов, например:</p><pre class="programlisting">days: [1-3, 6]</pre><p>В такой конфигурации плейлист будет активен в понедельник, вторник, среду и субботу.</p></dd><dt><span class="term"><code class="option">labels</code></span></dt><dd><p>Список меток для выбора композиций.  Метки с префиксом "-" исключают композицию, метки с префиксом "+"
            обязательны, из меток без префикса должна присутствовать хотя бы одна.  Пример:</p><pre class="programlisting">labels: [rock, punk, +female, -russian]</pre><p>В такой конфигурации в плейлист попадут композиции с метками "rock" или "punk" с женским вокалом не на
            русском языке.</p><p>При использовании этого параметра параметр <code class="option">name</code> в качестве метки не
            используется.</p></dd><dt><span class="term"><code class="option">sticky_labels</code></span></dt><dd><p>Список меток, которые должны «прилипать» к плейлисту при обнаружении.  Если из плейлиста выбрана
            композиция с однои из этих меток, она будет добавлена к значению свойства <code class="option">labels</code> плейлиста
            в качестве обязательной и пробудет там до смены плейлиста.</p><p>Пример конфигурации:</p><pre class="programlisting">labels: [music]
sticky_labels: [rock, jazz, 8bit]</pre><p>В такой конфигурации если из плейлиста будет выбрана композиция с меткой «rock», то свойство
            <code class="option">labels</code> примет значение «[music, +rock]» и до смены плейлиста будут звучать только
            композиции с этими двумя метками.</p><p>Эта функция позволяет разбивать плейлист на случайные блоки из похожих песен, без резких перепадов (не
            забудьте регулярно встревающий плейлист с джинглами, иначе липкая метка залипнет до перезапуска
            сервера).</p></dd><dt><span class="term"><code class="option">program</code></span></dt><dd><p>Имя программы.  Этим свойством отмечаются ключевые плейлисты (исключая джинглы и прочие сопутствующие)
            для того, чтобы отслеживать переключение между программами.  При выборе композиции из плейлиста с таким
            свойством его значение сравнивается с предыдущим, если они отличаются — запускается внешняя программа
            (обычно используется для отражения состояния на сайте), отправляется сообщение в чат.</p></dd><dt><a name="preroll-playlist-option" id="preroll-playlist-option"></a><span class="term"><code class="option">preroll</code></span></dt><dd><p>Список меток, по которым подбирается <a class="link" href="#preroll" title="Подмотка">подмотка</a> для композиций из
            текущего плейлиста.  Композиции из текущего плейлиста будут предваряться случайной композицей с одной из
            указанных меток.  Этот параметр обычно используется для добавления анонсов, например, о том, что сейчас
            прозвучит подкаст.</p></dd><dt><span class="term"><code class="option">strategy</code></span></dt><dd><p>Определяет алгоритм выбора случайной композиции.  Значение «fresh» включает алгоритм, не учитывающий
            голоса слушателей: он выбирает случайную из пяти композиций с наименьшим количеством проигрываний.  Алгоритм
            «oldest» всегда выбирает композицию, не звучавшую дольше всего (сортирует по дате последнего
            проигрывания).</p></dd></dl></div></div><div class="section" title="Ручное программирование"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="custom-playlist" id="custom-playlist"></a>Ручное программирование</h2></div></div></div><p>Ручное управление позволяет вручную указать метки для использования в качестве виртуального плейлиста на
      ближайшее время.  Например, если менеджер станции хочет, чтобы ближайший час играл рок с женским вокалом, он может
      отправить jabber-боту команду <a class="link" href="#jabber-play"><span class="command"><strong>play</strong></span></a>:</p><pre class="programlisting">play rock +female</pre><p>Эта функция доступна и в командной строке:</p><pre class="programlisting">ardj play rock +female</pre><p>Управление из командной строки предназначено, в основном, для использования внутри скриптов.  Пример
      конфигурации, включающей на время прямого эфира спокойную иструментальную музыку, можно найти в папке
      <code class="filename">doc/examples/custom-playlist-on-live</code>.</p></div><div class="section" title="Управление очередью (заказы)"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="queue" id="queue"></a>Управление очередью (заказы)</h2></div></div></div><p>Любой слушатель может заказывать композиции, отправляя jabber-боту команду <a class="link" href="#jabber-queue"><span class="command"><strong>queue</strong></span></a>.  Эта команда принимает в качестве параметра фрагмент имени
      исполнителя или заголовка композиции, ей идентификатор или список меток.  Найденная композиция добавляется в конец
      очереди.  При выборе следующей композиции для проигрывания очередь имеет максимальный приоритет; за ней следует
      <a class="link" href="#custom-playlist" title="Ручное программирование">виртуальный плейлист</a>, затем <a class="link" href="#playlists" title="Плейлисты">остальные
      плейлисты</a>.</p><p>Привелегированные пользователи могут добавлять композиции в любом количестве и в любое время.  Обычные
      пользователи могут добавлять по одной композиции за раз, и к таким композициям в качестве <a class="link" href="#preroll" title="Подмотка">подмотки</a> добавляется случайная композиция с меткой "queue-jingle" (смысл этих ограничений
      в том, чтобы резвящийся слушатель был очевиден, чтобы его нельзя было принять за дефект программного
      обеспечения).</p><p>Рекомендуемый подход к заказу композиций таков: сначала нужно найти композицию командой <a class="link" href="#jabber-find"><span class="command"><strong>find</strong></span></a>, затем добавить её в очередь по идентификатору командой <a class="link" href="#jabber-queue"><span class="command"><strong>queue</strong></span></a>.</p></div><div class="section" title="Подмотка"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="preroll" id="preroll"></a>Подмотка</h2></div></div></div><p>Подмотка (англ. preroll) — это композиция, автоматически вставляемая в плейлист перед композицией, которая
      была выбрана в соответствие с его настройками.  Подмотка используется для акцентирования внимания на конкретных
      композициях (например, если у исполнителя скоро концерт).</p><p>Есть два способа настройки подмотки.  Они сводятся к определению меток, по которым выбирается случайный
      файл, который и является подмоткой (подробности описаны в подразделах).  Оба метода используются всегда: сначала
      собираются метки для плейлиста, затем
      - метки для текущей композиции, по ним выбирается случайная композиция, которая и является подмоткой.</p><div class="section" title="Подмотка для плейлиста"><div class="titlepage"><div><div><h3 class="title"><a name="preroll-playlist" id="preroll-playlist"></a>Подмотка для плейлиста</h3></div></div></div><p>Подмотка на уровне плейлиста создаётся с помощью <a class="link" href="#preroll-playlist-option">свойстве preroll</a>
  плейлиста.  В этом свойстве указывается список меток, по которым выбирается подмотка.  Пример настройки
  плейлиста:</p><pre class="programlisting">- name: heavy_music
  labels: [music, +heavy]
  preroll: [heavy-preroll]
  delay: 30</pre><p>В такой конфигурации в плейлист попадут композиции с метками "music" и "heavy", а перед ними будет каждый раз
  звучать случайная композиция с меткой "heavy-preroll".</p></div><div class="section" title="Подмотка для меток"><div class="titlepage"><div><div><h3 class="title"><a name="preroll-labels" id="preroll-labels"></a>Подмотка для меток</h3></div></div></div><p>Подмотка на уровне меток используется в случаях, когда она нужна в нескольких или во всех плейлистах сразу, но
  не обязательно для всех композиций.  С помощью этой функции можно, в частности, создать подмотку для отдельной
  композиции (например, для результата работы команды <a class="link" href="#jabber-speak"><span class="command"><strong>speak</strong></span></a>).</p><p>Для выбора подмотки этого уровня ко всем меткам композиции добавляется суффикс "-preroll" и выбирается случайный
  файл с одной из полученных меток.  Например, если из плейлиста была выбрана композиция с метками "rock", "female" и
  "vocals", подмотка будет выбираться по меткам "rock-preroll", "female-preroll" и "vocals-preroll" (достаточно одной из
  них).</p></div></div></div><div class="chapter" title="Глава 5. Использование"><div class="titlepage"><div><div><h2 class="title"><a name="usage" id="usage"></a>Глава 5. Использование</h2></div></div></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="section"><a href="#adding-music">Добавление музыки</a></span></dt><dt><span class="section"><a href="#voting">Оценка композиций</a></span></dt><dt><span class="section"><a href="#listening-statistics">Получение статистики</a></span></dt></dl></div><div class="section" title="Добавление музыки"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adding-music" id="adding-music"></a>Добавление музыки</h2></div></div></div><p>Для добавления музыки в <a class="link" href="#media-db" title="Медиатека">медиатеку</a> её следует сложить в папку
      <code class="filename">/var/lib/ardj/incoming</code> и выполнить команду <span class="command"><strong>ardj <a class="link" href="#cli-add-incoming">add-incoming-tracks</a></strong></span>, или послать jabber-боту команду
      <span class="command"><strong>upload</strong></span>.  После этого музыка будет обработана (посчитан ReplayGain) и перемещена в медиатеку. 
      Добавлять файлы в медиатеку вручную не следует: в базу данных они не попадут; вручную их там можно только
      спрятать.</p><p>При копировании в медиатеку из метаданных файлов считываются значения тэгов "artist" и "title", остальные
      привычные тэги игнорируются.  Из непривычных поддерживается тэг "ardj", который может содержать метки, пример
      значения:</p><pre class="programlisting">ardj=1;labels=music,rock,loud</pre></div><div class="section" title="Оценка композиций"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="voting" id="voting"></a>Оценка композиций</h2></div></div></div><p>Оценивать композиции может любой слушатель, имеющий аккаунт в сети Jabber.  Для этого по мере прослушивания
      эфира следует отправлять специальному роботу команды <a class="link" href="#jabber-rocks"><span class="command"><strong>rocks</strong></span></a>,
      если композиция нравится, или <a class="link" href="#jabber-sucks"><span class="command"><strong>sucks</strong></span></a>, если не нравится.  Все
      голоса записываются и влияют на <a class="link" href="#ratings" title="Рейтинг композиций">рейтинг</a>.</p><p>Чтобы проголосовать за композицию, которая сейчас не звучит (например, если вы опоздали), можно указать её
      идентификатор:</p><pre class="programlisting">rocks 1234</pre></div><div class="section" title="Получение статистики"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="listening-statistics" id="listening-statistics"></a>Получение статистики</h2></div></div></div><p>С помощью команды <a class="link" href="#cli-export-total"><span class="command"><strong>ardj export-total-listeners</strong></span></a>
      можно получить информацию о том, какая композиция сколькими слушателями была прослушана за всё время работы
      станции.  При каждом проигрывании композиции в базу данных складывается запись о времени проигрывания и количестве
      слушателей, которое сообщает icecast2; в этом отчёте данные суммируются.  Результат выводится в формате CSV и
      пригоден для загрузки в любой табличный процессор.  Формат файла и пример записи:</p><div class="example"><a name="total-playlog-example" id="total-playlog-example"></a><p class="title"><b>Пример 5.1. Общий отчёт о прослушиваниях</b></p><div class="example-contents"><pre class="programlisting">last_played,artist,title,listeners,track_id,weight
2011-10-24 07:48:15,20lb Sounds,Jimmy Carter,158,5327,1.18
2011-10-24 17:54:55,2nd Season,It's Your Time To Rise,36,5735,1.25
2011-10-24 01:01:02,30[eks],Hate It When They Do This,157,5736,1.25</pre></div></div><br class="example-break" /><p>Более подробную статистику за прошедшие сутки можно получить по команде <a class="link" href="#cli-export-yesterday"><span class="command"><strong>ardj export-yesterday-listeners</strong></span></a>.  В отчёте будут
      перечислены все проигранные композиции, без суммирования данных, наример:</p><div class="example"><a name="daily-playlog-example" id="daily-playlog-example"></a><p class="title"><b>Пример 5.2. Суточный отчёт о прослушиваниях</b></p><div class="example-contents"><pre class="programlisting">time,track_id,artist,title,listeners
2011-10-24 00:02:39,6384,StrangeZero,Zero Land,4
2011-10-24 00:09:20,3714,Loveshadow,The Garden (Waiting),4
2011-10-24 00:14:13,5076,Koalips,Wurtzite,4</pre></div></div><br class="example-break" /></div></div><div class="chapter" title="Глава 6. Web API"><div class="titlepage"><div><div><h2 class="title"><a name="webapi" id="webapi"></a>Глава 6. Web API</h2></div></div></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="section"><a href="#auth-json">api/auth.json</a></span></dt><dt><span class="section"><a href="#status-json">api/status.json</a></span></dt><dt><span class="section"><a href="#track-rocks-json">api/track/rocks.json</a></span></dt><dt><span class="section"><a href="#track-sucks-json">api/track/sucks.json</a></span></dt><dt><span class="section"><a href="#track-info-json">api/track/info.json</a></span></dt></dl></div><p>WebAPI позволяет сторонним приложениям общаться со станцией используя протоколы HTTP и JSON.  Результат всегда
  возвращается в виде отформатированного JSON объекта, с отступами и юникодными символами.</p><p>При использовании расширения <code class="filename">.js</code> результат возвращается в виде готового фрагмента скрипта,
  пригодного для включения в HTML-страницу.  По умолчанию значение записывается в переменную
  <code class="varname">response</code>, другое название можно указать с помощью параметра <code class="varname">var</code>, а с помощью
  параметра <code class="varname">callback</code> можно указать имя функции, которая должна быть выполнена после присвоения
  переменной значения.  Пример:</p><div class="example"><a name="web-api-js" id="web-api-js"></a><p class="title"><b>Пример 6.1. Использование JS-интерфейса WebAPI</b></p><div class="example-contents"><pre class="programlisting">$ curl 'http://music.tmradio.net/api/status.js?var=foo&amp;callback=bar'
var foo = {...}; bar(foo);</pre></div></div><br class="example-break" /><div class="section" title="api/auth.json"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="auth-json" id="auth-json"></a>api/auth.json</h2></div></div></div><p>Используется для получения токена.  Запрос следует отправлять методом POST, идентификатор пользователя и его
    тип (jid или email) указываются параметрами <code class="varname">id</code> и <code class="varname">type</code>.  Возвращает серверное
    сообщение, пользователь получает дальнейшие инструкции через jabber или email.  Пример:</p><pre class="programlisting">$ curl -X POST -d 'id=alice@example.com&amp;type=email' 'http://music.tmradio.net/api/auth.json'
{
  "status": "ok", 
  "message": "You'll soon receive a message with a confirmation link."
}</pre><p>После этого пользователь получает ссылку для подтверждения токена, который сообщает программе.  С помощью
    токена можно <a class="link" href="#track-rocks-json" title="api/track/rocks.json">голосовать</a>.</p></div><div class="section" title="api/status.json"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="status-json" id="status-json"></a>api/status.json</h2></div></div></div><p>Возвращает информацию о проигрываемой на данный момент композиции.  Формат результата аналогичен <a class="link" href="#track-info-json" title="api/track/info.json">api/track/info.json</a>.  Пример:</p><pre class="programlisting">$ curl http://music.tmradio.net/api/track/info.json
{
  "real_weight": 1.8666666666666667, 
  "last_played": 1326743103, 
  "weight": 1.8666666666666667, 
  "image": null, 
  "labels": [ "news", "preroll-not-wanted", "special" ], 
  "download": null, 
  "id": 4598, 
  "count": 5955, 
  "filepath": "/radio/music/c/f/cf4970391cb99e64a3b317423d592562.ogg", 
  "artist": "Эхо Москвы", 
  "title": "Новости", 
  "filename": "c/f/cf4970391cb99e64a3b317423d592562.ogg", 
  "length": 97
}</pre></div><div class="section" title="api/track/rocks.json"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="track-rocks-json" id="track-rocks-json"></a>api/track/rocks.json</h2></div></div></div><p>Записывает одобрение пользователем текущей композиции.  Для голосования за композицию, звучавшую ранее, её
    идентификатор можно указать в параметре <code class="varname">id</code>.</p><p>Запросы нужно отправлять методом POST, указав полученный при аутентификации токен.  Пример:</p><pre class="programlisting">$ curl -X POST -d 'token=baadf00d&amp;track_id=123' http://music.tmradio.net/api/track/rocks.json
{
  "status": "ok", 
  "message": "OK, current weight of track #123 is 2.9333."
}</pre></div><div class="section" title="api/track/sucks.json"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="track-sucks-json" id="track-sucks-json"></a>api/track/sucks.json</h2></div></div></div><p>Записывает неодобрение пользователем текущей композиции.  Для голосования против композиции, звучавшей ранее,
    её идентификатор можно указать в параметре <code class="varname">id</code>.</p><p>Запросы нужно отправлять методом POST, указав полученный при аутентификации токен.  Пример:</p><pre class="programlisting">$ curl -X POST -d 'token=baadf00d&amp;track_id=123' http://music.tmradio.net/api/track/sucks.json
{
  "status": "ok", 
  "message": "OK, current weight of track #123 is 1.9333."
}</pre></div><div class="section" title="api/track/info.json"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="track-info-json" id="track-info-json"></a>api/track/info.json</h2></div></div></div><p>Возвращает информацию о композиции идентификатор которой указан в параметре <code class="varname">id</code>. 
    Пример:</p><pre class="programlisting">$ curl 'http://music.tmradio.net/track/info.json?id=6065'
{
 "real_weight": 1.0, 
 "last_played": 1326743926, 
 "weight": 1.1499999999999999, 
 "image": "http://userserve-ak.last.fm/serve/64s/30245783.jpg", 
 "labels": [ "calm", "female", "fresh", "music", "vocals", "source:jamendo.com" ], 
 "download": null, 
 "id": 6065, 
 "count": 5, 
 "filepath": "/radio/music/7/4/746fee45f4b312d28bba71b7cb2529fa.ogg", 
 "artist": "KOOQLA", 
 "title": "In my mind", 
 "filename": "7/4/746fee45f4b312d28bba71b7cb2529fa.ogg", 
 "length": 296
}</pre><div class="variablelist" title="Возможные свойства"><p class="title"><b>Возможные свойства</b></p><dl><dt><span class="term">id</span></dt><dd><p>Уникальный числовой идентификатор композиции.</p></dd><dt><span class="term">artist</span></dt><dd><p>Название исполнителя.</p></dd><dt><span class="term">title</span></dt><dd><p>Название композиции.</p></dd><dt><span class="term">weight</span></dt><dd><p>Текущий вес композиции.  Влияет на частоту проигрывания.  Изменяется при обращении к <a class="link" href="#track-rocks-json" title="api/track/rocks.json">api/track/rocks.json</a> и <a class="link" href="#track-sucks-json" title="api/track/sucks.json">api/track/sucks.json</a>.  Нулевой вес означает, что композиция была удалена из
          ротации.</p></dd><dt><span class="term">real_weight</span></dt><dd><p>Реальный вес композиции, рассчитанный автоматически.  Текущий вес (<code class="varname">weight</code>) к нему
          по-немногу смещается при каждом проигрывании композиции.</p></dd><dt><span class="term">count</span></dt><dd><p>Количество проигрываний композиции.</p></dd><dt><span class="term">length</span></dt><dd><p>Продолжительность композиции в секундах.</p></dd><dt><span class="term">last_played</span></dt><dd><p>UNIX-время последнего проигрывания композиции.</p></dd><dt><span class="term">labels</span></dt><dd><p>Метки композиции.  Используются для <a class="link" href="#programming" title="Глава 4. Программирование эфира">включения в плейлисты</a>.</p></dd><dt><span class="term">image</span></dt><dd><p>URL иллюстрации к композиции.  Обычно ведёт на сервер LastFM; картинка обычно имеет размер 64×64, но
          он может быть и другим (особенно если картинка с Jamendo).</p></dd><dt><span class="term">download</span></dt><dd><p>URL для скачивания композиции.  Есть не всегда.  Когда есть, не всегда является ссылкой на чистый
          MP3-файл, поэтому при сохранении лучше сформировать имя файла самостоятельно, на основе имени исполнителя и
          композиции.</p></dd><dt><span class="term">last_played</span></dt><dd><p>UNIX-время последнего проигрывания композиции.</p></dd><dt><span class="term">filename</span></dt><dd><p>Относительное имя файла в файловом хранилище.</p></dd><dt><span class="term">filepath</span></dt><dd><p>Абсолютное имя файла в файловом хранилище.</p></dd></dl></div></div></div><div class="appendix" title="Приложение A. Описание параметров командной строки"><div class="titlepage"><div><div><h2 class="title"><a name="command-line" id="command-line"></a>Приложение A. Описание параметров командной строки</h2></div></div></div><p>Интерфейс ко всем функциям предоставляет программа <span class="command"><strong>ardj</strong></span>.  Эта программа первым параметром
    принимает имя команды, которое может сопровождаться дополнительными параметрами.  Все команды и возможные параметры
    описаны в этом разделе.</p><p>При использовании оболочек <span class="command"><strong>bash</strong></span> и <span class="command"><strong>zsh</strong></span> работает автодополнение команд и
    параметров, можно использовать кнопку TAB для ускоренного набора.</p><div class="variablelist"><dl><dt><a name="cli-add-incoming" id="cli-add-incoming"></a><span class="term"><code class="option">add-incoming-tracks</code></span></dt><dd><p>Ищет файлы в папке, указанной в параметре <code class="option">incoming_path</code> конфигурационного файла.  Все
          найденные файлы с расширениями <code class="filename">.mp3</code> и <code class="filename">.ogg</code> перемещаются в <a class="link" href="#media-db" title="Медиатека">медиатеку</a> и удаляются.  Если файл не может быть удалён — он игнорируется (чтобы не
          добавлять его повторно при каждом последующем вызове).</p><p>Эта команда является эквивалентом команды <span class="command"><strong>upload</strong></span> джаббера.</p></dd><dt><span class="term"><code class="option">config</code></span></dt><dd><p>Запускает текстовый редактор с открытым для редактирования конфигурационным файлом.</p></dd><dt><span class="term"><code class="option">console [jid]</code></span></dt><dd><p>Открывает интерактивную консоль, эмулирующую общение через джаббер (только без джаббера и вообще без
          использования сети).  Эта функция полезна для отладки, например, когда пользователь жалуется на неожиданное
          поведение команды, которое не воспроизводится у других пользователей.</p></dd><dt><span class="term"><code class="option">db-console</code></span></dt><dd><p>Открывает интерактивную консоль для работы с базой данных, SQLite или MySQL.  Может использоваться в
          скриптах (запросы надо передавать через stdin).</p></dd><dt><span class="term"><code class="option">db-init</code></span></dt><dd><p>Инициализация недостающих таблиц и индексов базы данных.  Эта процедура обычно выполняется при установке
          пакета и больше не нужна.  Выполнить её вручную может понадобиться, например, если вы случайно уничтожили базу
          данных и хотите начать сначала.</p></dd><dt><span class="term"><code class="option">db-purge</code></span></dt><dd><p>Удаляет из базы данных мусор, вроде неиспользуемых меток и файлов, относящихся к дорожкам, которые были
          удалены.</p></dd><dt><span class="term"><code class="option">db-stats</code></span></dt><dd><p>Показывает информацию о количестве композиций и их суммарной продолжительности, например: "2883 tracks,
          192.0 hours".</p></dd><dt><span class="term"><code class="option">download-artist name</code></span></dt><dd><p>Сохраняет запрос на загрузку песен указанного исполнителя.  Сама загрузка выполняется позже, в фоновом
          режиме.</p><p>Эта команда является эквивалентом команды <span class="command"><strong>download</strong></span> джаббера.</p></dd><dt><a name="cli-export-total" id="cli-export-total"></a><span class="term"><code class="option">export-total-listeners</code></span></dt><dd><p>Выводит в stdout общую <a class="link" href="#listening-statistics" title="Получение статистики">статистику прослушиваний</a>.</p></dd><dt><a name="cli-export-yesterday" id="cli-export-yesterday"></a><span class="term"><code class="option">export-yesterday-listeners</code></span></dt><dd><p>Выводит в stdout подробную <a class="link" href="#listening-statistics" title="Получение статистики">статистику прослушиваний</a> за
          последние сутки.</p></dd><dt><span class="term"><code class="option">find-new-tracks</code></span></dt><dd><p>Запускает поиск новой музыки.  Сначала выбираются исполнители, имеющие дорожки с оценками выше средней,
          затем в Last.fm и Jamendo ищется новая музыка этих исполнителей, которую позволено скачивать.</p></dd><dt><span class="term"><code class="option">fix-artist-names</code></span></dt><dd><p>Проверяет имя исполнителя по базе данных Last.fm и исправляет, если сервер рекомендует это.  Обычно это
          приводит к изменению регистра, но может и полностью заменить имя, например, исправив ложную
          транслитерацию.</p></dd><dt><span class="term"><code class="option">help</code></span></dt><dd><p>Выводит краткую сводку по поддерживаемым командам.</p></dd><dt><span class="term"><code class="option">mark-hitlist</code></span></dt><dd><p>Отмечает примерно десяток лучших песен меткой "hitlist".  Реальное количество дорожек обычно чуть
          больше, потому что отмечаются все дорожки с рейтингом не ниже десятой по счёту (то есть на десятом месте может
          быть несколько дорожек).</p><p>Если настроено взаимодействие с Last.fm, отмеченные дорожки добавляются в «любимые».</p></dd><dt><span class="term"><code class="option">mark-liked-by label jid1 jid2 ...</code></span></dt><dd><p>Отмечает меткой "label" композиции, которые нравятся всем указанным пользователям.  Эту команду можно
          использовать для создания специфической атмосферы перед прямыми включениями, когда известны будущие
          участники.</p></dd><dt><span class="term"><code class="option">mark-long</code></span></dt><dd><p>Отмечает меткой "long" композиции с продолжительностью выше средней.  Можно использовать метку для
          исключения слишком длинных песен из дневной ротации.</p></dd><dt><span class="term"><code class="option">mark-orphans</code></span></dt><dd><p>Отмечает меткой "orphan" композиции, не находящиеся ни в одном плейлисте.</p></dd><dt><span class="term"><code class="option">merge-votes</code></span></dt><dd><p>Склеивает голоса пользователей в соответствии со значением параметра <code class="option">jabber_aliases</code>
          конфигурационного файла.</p></dd><dt><span class="term"><code class="option">queue-flush</code></span></dt><dd><p>Очищает <a class="link" href="#queue" title="Управление очередью (заказы)">очередь заказов</a>.</p></dd><dt><span class="term"><code class="option">scan-replaygain [files...]</code></span></dt><dd><p>Запускает сканирование ReplayGain для всех файлов, у которых нет нужной информации.  Если параметр
          <code class="option">files</code> не указан — сканирует все файлы в <a class="link" href="#media-db" title="Медиатека">медиатеке</a>.</p><p>Для сканирования используются программы <span class="command"><strong>mp3gain</strong></span> и
          <span class="command"><strong>vorbisgain</strong></span>.</p></dd><dt><span class="term"><code class="option">serve</code></span></dt><dd><p>Запускает веб-сервер для доступа к Web API.  Сервер обычно доступен по адресу localhost:8080, но этот
          адрес может быть изменён параметром <code class="option">api_socket</code> конфигурационного файла.  Сервер используется
          плагином для <span class="command"><strong>ices</strong></span> и некоторыми командами джаббера.</p><p>Запускать сервер вручную может понадобиться только в отладочных целях.  В повседневной работе его
          запускает системная служба, ещё это можно сделать командой <span class="command"><strong>sudo start ardj-server</strong></span> (по
          умолчанию команда доступна без пароля всем пользователям из группы "ardj").</p></dd><dt><span class="term"><code class="option">tags files...</code></span></dt><dd><p>Выводит содержимое поддерживаемых тэгов.  Эта функция обычно используется в отладочных целях, чтобы
          убедиться в работоспособности функции чтения тэгов и в корректности самих тэгов.  Для работы используется
          библиотека <a class="ulink" href="http://code.google.com/p/mutagen/" target="_top">python-mutagen</a>.</p></dd><dt><span class="term"><code class="option">twit "text..."</code></span></dt><dd><p>Отправляет указанный текст в Твиттер.  Работает только при корректном заполнении параметра
          <code class="option">twitter</code> конфигурационного файла, в противном случае пишет что делать.</p></dd><dt><span class="term"><code class="option">twit-replies</code></span></dt><dd><p>Выводит сообщения, отправленные на имя используемой учётной записи.  Предположительно бесполезная
          функция.</p></dd><dt><span class="term"><code class="option">update-schedule</code></span></dt><dd><p>Собирает на Last.fm информацию о предстоящих концертах интересных исполнителей (имеющих дорожки с
          оценками выше средней) и сохраняет её в файл типа JavaScript, указанный в параметре
          <code class="option">event_schedule_path</code> конфигурационного файла; этот файл можно использовать для вывода карты на
          сайте.</p><p>Работает только при корректной настройке взаимодействия с Last.fm.</p></dd><dt><span class="term"><code class="option">update-track-lengths</code></span></dt><dd><p>Сверяет продолжительность файлов с информацией из базы данных и корректирует её.  Полезно запускать
          после ручного вмешательства в <a class="link" href="#media-db" title="Медиатека">медиатеку</a>.</p></dd><dt><span class="term"><code class="option">update-track-weights</code></span></dt><dd><p>Сдвигает текущий рейтинг каждой дорожки к реальному.  Вредная функция; описанная процедура выполняется
          автоматически при каждом проигрывании, ручной запуск только сбивает рейтинги.</p></dd><dt><span class="term"><code class="option">xmpp-send "message text" [jid]</code></span></dt><dd><p>Отправляет сообщение указанному пользователю или в чат, если пользователь не указан (название комнаты
          указывается в параметре <code class="option">jabber_chat_room</code> конфигурационного файла).</p></dd></dl></div></div><div class="appendix" title="Приложение B. Описание команд jabber-бота"><div class="titlepage"><div><div><h2 class="title"><a name="jabber-commands" id="jabber-commands"></a>Приложение B. Описание команд jabber-бота</h2></div></div></div><div class="variablelist"><dl><dt><a name="jabber-admins" id="jabber-admins"></a><span class="term"><span class="command"><strong>admins</strong></span></span></dt><dd><p>Выводит список администраторов.  Учитываются администраторы, указанные в конфигурационном файле, и
          пользователи, наиболее активно голосовавшие (если эта функция включена).</p></dd><dt><a name="jabber-download" id="jabber-download"></a><span class="term"><span class="command"><strong>download</strong></span> <em class="replaceable"><code>имя исполнителя</code></em></span></dt><dd><p>Ищет свободно распространяемые композиции указанного исполнителя в Last.fm и Jamendo и загружает 3 штуки.
    Если в медиатеке уже есть композиции указанного исполнителя — сообщает об этом и ничего не загружает.</p><div class="example"><a name="jabber-download-example" id="jabber-download-example"></a><p class="title"><b>Пример B.1. Загрузка музыки из открытых источников</b></p><div class="example-contents"><pre class="programlisting">&gt; download cool music
Это займёт какое-то время, я сообщу о результате.
Could not find anything by "cool music" on Last.fm and Jamendo.</pre></div></div><br class="example-break" /></dd><dt><a name="jabber-find" id="jabber-find"></a><span class="term"><span class="command"><strong>find</strong></span> <em class="replaceable"><code>поисковый_запрос</code></em></span></dt><dd><p>Выводит список композиций, содержащих указанную строку.</p></dd><dt><a name="jabber-news" id="jabber-news"></a><span class="term"><span class="command"><strong>news</strong></span></span></dt><dd><p>Выводит список последних 10 загруженных композиций, например:</p><pre class="programlisting">Recently added tracks:                               
«Песня идущего домой» by Ю-Питер — #6899 ⚖1.00 ♺0    
«Девушка по городу» by Ю-Питер — #6898 ⚖1.00 ♺0      
«Эта музыка будет вечной» by Ю-Питер — #6897 ⚖1.00 ♺0</pre></dd><dt><a name="jabber-play" id="jabber-play"></a><span class="term"><span class="command"><strong>play</strong></span> [<span class="optional">--time=время</span>] <em class="replaceable"><code>метки</code></em></span></dt><dd><p>Включает <a class="link" href="#custom-playlist" title="Ручное программирование">виртуальный плейлист</a> из указанных меток на указанное
    время (60 минут по умолчанию).</p><div class="example"><a name="jabber-play-example" id="jabber-play-example"></a><p class="title"><b>Пример B.2. Создание плейлиста на ходу</b></p><div class="example-contents"><pre class="programlisting">&gt; play @lounge @+instrumental @-ambient
OK.</pre><p>При этом в чат отправляется такое сообщение:</p><pre class="programlisting">Playlist for next 60 minutes: @lounge.</pre><p>Отмена созданного плейлиста:</p><pre class="programlisting">&gt; play all
OK.</pre></div></div><br class="example-break" /></dd><dt><a name="jabber-queue" id="jabber-queue"></a><span class="term"><span class="command"><strong>queue</strong></span> [<span class="optional">флаги</span>] <em class="replaceable"><code>поисковый_запрос</code></em></span></dt><dd><p>Добавляет в <a class="link" href="#queue" title="Управление очередью (заказы)">очередь</a> композиции, удовлетворяющие запросу.</p></dd><dt><a name="jabber-restart" id="jabber-restart"></a><span class="term"><span class="command"><strong>restart</strong></span></span></dt><dd><p>Перезапускает робота.  Обычно эта команда используется после внесения изменений в конфигурационный файл.  Если
    доступа к роботу нет, в системе Debian/Ubuntu это можно сделать командой:</p><pre class="programlisting">sudo restart ardj-jabber</pre></dd><dt><a name="jabber-rocks" id="jabber-rocks"></a><span class="term"><span class="command"><strong>rocks</strong></span> [<span class="optional"><em class="replaceable"><code>track_id</code></em></span>]</span></dt><dd><p>Добавляет голос в пользу указанной (или текущей) композиции, увеличивая её <a class="link" href="#ratings" title="Рейтинг композиций">рейтинг</a>.</p></dd><dt><a name="jabber-speak" id="jabber-speak"></a><span class="term"><span class="command"><strong>speak</strong></span> <em class="replaceable"><code>текст</code></em></span></dt><dd><p>Преобразует текст в голос и заряжает в <a class="link" href="#queue" title="Управление очередью (заказы)">очередь проигрывания</a>.  Работает
          только если <a class="link" href="#festival" title="Настройка синтезатора речи">настроен синтезатор речи</a>.</p></dd><dt><a name="jabber-sucks" id="jabber-sucks"></a><span class="term"><span class="command"><strong>sucks</strong></span> [<span class="optional"><em class="replaceable"><code>track_id</code></em></span>]</span></dt><dd><p>Добавляет голос против указанной (или текущей) композиции, уменьшая её <a class="link" href="#ratings" title="Рейтинг композиций">рейтинг</a>.</p></dd><dt><a name="jabber-tags" id="jabber-tags"></a><span class="term"><span class="command"><strong>tags</strong></span> <em class="replaceable"><code>-old +new</code></em> [<span class="optional">for <em class="replaceable"><code>track_id</code></em></span>]</span></dt><dd><p>Изменяет метки композиции.  Метки используются для привязки композиций к <a class="link" href="#playlists" title="Плейлисты">плейлистам</a>.  Изменения вступают в силу незамедлительно.</p><div class="example"><a name="jabber-tags-example" id="jabber-tags-example"></a><p class="title"><b>Пример B.3. Изменение меток композиции</b></p><div class="example-contents"><pre class="programlisting">&gt; find @tagme
Found 63 tracks, showing 10:  
«Neon» by Denergized — #4935 ⚖1.20 ♺4 @tagme
&gt; tags -tagme industrial vocals for 4935
New labels: industrial, vocals.
</pre></div></div><br class="example-break" /></dd></dl></div></div></div></body></html>
